{% extends 'core/base.html' %}
{% load static %}

{% block title %}{% if product %}Sửa sản phẩm: {{ product.name }}{% else %}Thêm sản phẩm mới{% endif %}{% endblock %}

{% block extra_css %}
<style>
    .image-upload-zone {
        border: 2px dashed #dee2e6;
        border-radius: 0.5rem;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f8f9fa;
    }
    .image-upload-zone:hover {
        border-color: #0d6efd;
        background: #f1f8ff;
    }
    .preview-container img {
        object-fit: cover;
        width: 100%;
        height: 100px;
        border-radius: 4px;
    }
    .gallery-preview-item {
        position: relative;
        margin-bottom: 10px;
    }
    .sticky-sidebar {
        position: sticky;
        top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header & Actions -->
    <form method="post" enctype="multipart/form-data" id="productForm">
        {% csrf_token %}
        
        <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-1">
                        <li class="breadcrumb-item"><a href="{% url 'store_dashboard' store.store_id %}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'store_products' store.store_id %}">Sản phẩm</a></li>
                        <li class="breadcrumb-item active">{% if product %}Chỉnh sửa{% else %}Thêm mới{% endif %}</li>
                    </ol>
                </nav>
                <h2 class="h3 fw-bold mb-0">{% if product %}{{ product.name }}{% else %}Thêm sản phẩm mới{% endif %}</h2>
                </div>
            <div class="d-flex gap-2">
                <a href="{% url 'store_products' store.store_id %}" class="btn btn-outline-secondary">Cancel</a>
                {% if product %}
                    <button type="submit" name="action" value="update" class="btn btn-primary px-4">
                        <i class="fas fa-save me-2"></i>Update
                    </button>
                    <button type="submit" name="action" value="delete" class="btn btn-danger px-4">
                        <i class="fas fa-save me-2"></i>Delete
                    </button>
                {% else %}
                    <button type="submit" name="save" class="btn btn-primary px-4">
                        <i class="fas fa-save me-2"></i>Save
                    </button>
                {% endif %}
               
        </div>
    </div>

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}

        <div class="row">
            <!-- LEFT COLUMN: Main Info -->
            <div class="col-lg-8">
                <!-- 1. General Info -->
                <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                        <h5 class="card-title fw-bold mb-3">Thông tin chung</h5>
                        <div class="mb-3">
                            <label for="name" class="form-label">Tên sản phẩm <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" name="name" required
                                   value="{{ product.name|default:'' }}" placeholder="Ví dụ: Cà chua hữu cơ Đà Lạt">
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Mô tả chi tiết</label>
                            <textarea class="form-control" id="description" name="description" rows="6" 
                                      placeholder="Mô tả đặc điểm, nguồn gốc, hướng dẫn sử dụng...">{{ product.description|default:'' }}</textarea>
                        </div>
                                    </div>
                                </div>

                <!-- 2. Pricing & Inventory (Ẩn nếu có variant) -->
                <div class="card shadow-sm border-0 mb-4" id="simple-pricing-card">
                    <div class="card-body p-4">
                        <h5 class="card-title fw-bold mb-3">Giá & Kho hàng</h5>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="price" class="form-label">Giá bán (VNĐ) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="price" name="price" step="1000"
                                       value="{{ product.price|floatformat:'0'|default:'' }}" placeholder="0" required>
                            </div>
                            <div class="col-md-3">
                                <label for="base_unit" class="form-label">Đơn vị tính</label>
                                <input type="text" class="form-control" id="base_unit" name="base_unit" 
                                       value="{{ product.base_unit|default:'' }}" placeholder="kg, hộp, bó...">
                            </div>
                            <div class="col-md-3">
                                <label for="stock" class="form-label">Số lượng tồn kho <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="stock" name="stock" min="0"
                                       value="{{ product.stock|default:0 }}" placeholder="0" required>
                                </div>
                            <div class="col-md-3">
                                <label for="SKU" class="form-label">Mã SKU</label>
                                <input type="text" class="form-control" id="SKU" name="SKU" 
                                       value="{{ product.SKU|default:'' }}" placeholder="Mã SKU (tự động nếu để trống)">
                            </div>
                        </div>
                                </div>
                            </div>

                <!-- 3. Variants Section -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title fw-bold mb-0">Biến thể sản phẩm</h5>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="has_variants" name="has_variants"
                                       {% if product.has_variants %}checked{% endif %}
                                       {% if product.variants.exists %}disabled{% endif %}>
                                <label class="form-check-label" for="has_variants">Sản phẩm có nhiều biến thể</label>
                            </div>
                        </div>
                        
                        <div id="variants-warning" class="alert alert-light border-warning text-warning" style="display: none;">
                            <i class="fas fa-info-circle me-2"></i>
                            Khi bật chế độ biến thể, giá và kho hàng sẽ được quản lý theo từng biến thể riêng biệt.
                        </div>
                        
                        <!-- Variants Form (Inline) - Hiển thị khi create hoặc edit nhưng chưa có variants -->
                        <div id="variants-form-container" style="display: none;">
                                <div class="mb-3">
                                <button type="button" class="btn btn-sm btn-outline-primary" id="add-variant-btn">
                                    <i class="fas fa-plus me-1"></i>Thêm biến thể
                                </button>
                                        </div>
                            <div id="variants-list">
                                <!-- Variants sẽ được thêm động bằng JavaScript -->
                            </div>
                        </div>
                        
                        <!-- Existing Variants Form (chỉ hiển thị khi edit và đã có variants) -->
                        {% if product and product.has_variants and variants %}
                            <div class="mt-3" id="existing-variants-table">
                                <h6 class="mb-3 fw-bold">Biến thể hiện có</h6>
                                {% for variant in variants %}
                                <div class="card mb-3 variant-edit-item" data-variant-id="{{ variant.variant_id }}">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="mb-0">Biến thể #{{ forloop.counter }}</h6>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       name="delete_variants" value="{{ variant.variant_id }}" 
                                                       id="delete_variant_{{ variant.variant_id }}">
                                                <label class="form-check-label text-danger" for="delete_variant_{{ variant.variant_id }}">
                                                    Xóa
                            </label>
                                            </div>
                                        </div>
                                        <input type="hidden" name="variants[{{ forloop.counter }}][variant_id]" value="{{ variant.variant_id }}">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Tên biến thể <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" 
                                                       name="variants[{{ forloop.counter }}][variant_name]" 
                                                       value="{{ variant.variant_name }}" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Giá (VNĐ) <span class="text-danger">*</span></label>
                                                <input type="number" class="form-control" 
                                                       name="variants[{{ forloop.counter }}][price]" 
                                                       value="{{ variant.price|floatformat:'0' }}" step="1000" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Số lượng tồn kho <span class="text-danger">*</span></label>
                                                <input type="number" class="form-control" 
                                                       name="variants[{{ forloop.counter }}][stock]" 
                                                       value="{{ variant.stock }}" min="0" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Mã SKU</label>
                                                <input type="text" class="form-control" 
                                                       name="variants[{{ forloop.counter }}][sku_code]" 
                                                       value="{{ variant.sku_code|default:'' }}">
                                            </div>
                                            <div class="col-md-12">
                                                <label class="form-label">Hình ảnh biến thể</label>
                                                {% if variant.image %}
                                                    <div class="mb-2">
                                                        <img src="{{ variant.image.url }}" class="rounded me-2" width="60" height="60" style="object-fit: cover;">
                                                        <small class="text-muted">Ảnh hiện tại</small>
                                                    </div>
                                                    {% endif %}
                                                <input type="file" class="form-control" 
                                                       name="variants[{{ forloop.counter }}][image]" 
                                                       accept="image/*">
                                                </div>
                                            <div class="col-md-12">
                                                <label class="form-label">Mô tả biến thể</label>
                                                <textarea class="form-control" 
                                                          name="variants[{{ forloop.counter }}][variant_description]" 
                                                          rows="2">{{ variant.variant_description|default:'' }}</textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <p class="text-muted text-center py-3">Chưa có biến thể nào.</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                        </div>
                </div>
            </div>
            
            <!-- RIGHT COLUMN: Sidebar -->
            <div class="col-lg-4">
                <div class="sticky-sidebar">
                    <!-- 1. Status & Organization -->
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-body p-4">
                            <h5 class="card-title fw-bold mb-3">Tổ chức</h5>
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold">Trạng thái</label>
                                <select class="form-select" name="is_active">
                                    <option value="on" {% if product.is_active %}selected{% endif %}>Đang bán (Active)</option>
                                    <option value="" {% if not product.is_active %}selected{% endif %}>Ẩn (Draft)</option>
                                </select>
                    </div>

                            <div class="mb-3">
                                <label for="category" class="form-label fw-bold">Danh mục</label>
                                <select class="form-select" id="category" name="category">
                                    <option value="">-- Chọn danh mục --</option>
                                    {% for category in categories %}
                                    <option value="{{ category.category_id }}" 
                                            {% if product.category_id == category.category_id %}selected{% endif %}>
                                        {{ category.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        </div>

                    <!-- 2. Media Management -->
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-body p-4">
                            <h5 class="card-title fw-bold mb-3">Hình ảnh</h5>
                            <!-- Gallery Images -->
                            <div class="mb-3">
                                <label class="form-label small text-muted text-uppercase">Thư viện ảnh</label>
                                
                                <!-- Existing Gallery -->
                                {% if product and product.images.exists %}
                                <div class="row g-2 mb-3">
                                    {% for img in product.images.all %}
                                    <div class="col-4 position-relative">
                                        <img src="{{ img.image.url }}" class="img-fluid rounded border">
                                        <!-- Nút xóa ảnh (Cần xử lý logic BE hoặc JS) -->
                </div>
                                    {% endfor %}
            </div>
            {% endif %}

                                <div class="image-upload-zone" onclick="document.getElementById('gallery_images').click()">
                                    <i class="fas fa-cloud-upload-alt fa-2x text-primary mb-2"></i>
                                    <p class="small mb-0 text-muted">Click để chọn nhiều ảnh</p>
                                </div>
                                <input type="file" class="d-none" id="gallery_images" name="gallery_images" accept="image/*" multiple onchange="previewGallery(this)">
                                
                                <div id="gallery-preview-container" class="row g-2 mt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Javascript tối ưu -->
<script>
    // 1. Logic ẩn/hiện Pricing khi chọn Variant
    const hasVariantsCheckbox = document.getElementById('has_variants');
    const pricingCard = document.getElementById('simple-pricing-card');
    const variantWarning = document.getElementById('variants-warning');
    const priceInput = document.getElementById('price');
    
    let variantCount = 0;

    function toggleVariantMode() {
        const variantsFormContainer = document.getElementById('variants-form-container');
        const existingVariantsTable = document.getElementById('existing-variants-table');
        const stockInput = document.getElementById('stock');
        
        if (hasVariantsCheckbox.checked) {
            pricingCard.style.opacity = '0.5';
            pricingCard.style.pointerEvents = 'none'; // Disable inputs
            variantWarning.style.display = 'block';
            priceInput.required = false;
            if (stockInput) stockInput.required = false;
            
            // Show variants form container (always show when has_variants is checked)
            if (variantsFormContainer) {
                variantsFormContainer.style.display = 'block';
            }
            // Show existing variants table if editing and has variants
            {% if product and variants %}
                if (existingVariantsTable) {
                    existingVariantsTable.style.display = 'block';
                }
            {% endif %}
    } else {
            pricingCard.style.opacity = '1';
            pricingCard.style.pointerEvents = 'auto';
            variantWarning.style.display = 'none';
            priceInput.required = true;
            if (stockInput) stockInput.required = true;
            if (variantsFormContainer) {
                variantsFormContainer.style.display = 'none';
            }
        }
    }

    // Add Variant Form
    function addVariantForm() {
        variantCount++;
        const variantsList = document.getElementById('variants-list');
        const variantHtml = `
            <div class="card mb-3 variant-form-item" data-variant-index="${variantCount}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Biến thể #${variantCount}</h6>
                        <button type="button" class="btn btn-sm btn-outline-danger remove-variant-btn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Tên biến thể <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="variants[${variantCount}][variant_name]" 
                                   placeholder="Ví dụ: 500g, Size M - Màu Đỏ" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Giá (VNĐ) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" name="variants[${variantCount}][price]" 
                                   step="1000" placeholder="0" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Số lượng tồn kho <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" name="variants[${variantCount}][stock]" 
                                   min="0" placeholder="0" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Mã SKU</label>
                            <input type="text" class="form-control" name="variants[${variantCount}][sku_code]" 
                                   placeholder="Tự động nếu để trống">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Hình ảnh biến thể</label>
                            <input type="file" class="form-control" name="variants[${variantCount}][image]" 
                                   accept="image/*">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Mô tả biến thể</label>
                            <textarea class="form-control" name="variants[${variantCount}][variant_description]" 
                                      rows="2" placeholder="Mô tả tùy chọn"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        `;
        variantsList.insertAdjacentHTML('beforeend', variantHtml);

        // Attach remove event listener
        const removeBtn = variantsList.querySelector(`[data-variant-index="${variantCount}"] .remove-variant-btn`);
        removeBtn.addEventListener('click', function() {
            this.closest('.variant-form-item').remove();
        });
    }

    // Initialize add variant button and variant mode toggle
document.addEventListener('DOMContentLoaded', function() {
        const addVariantBtn = document.getElementById('add-variant-btn');
        if (addVariantBtn) {
            addVariantBtn.addEventListener('click', addVariantForm);
        }
        
        // Initialize variant mode toggle
        if(hasVariantsCheckbox) {
            hasVariantsCheckbox.addEventListener('change', toggleVariantMode);
            // Run on load to set initial state
            toggleVariantMode();
        }
    });

    // 2. Preview Gallery (Nhiều ảnh)
    function previewGallery(input) {
        const container = document.getElementById('gallery-preview-container');
        container.innerHTML = ''; // Clear old previews for new selection
        
        if (input.files) {
            Array.from(input.files).forEach(file => {
                var reader = new FileReader();
                reader.onload = function (e) {
                    const div = document.createElement('div');
                    div.className = 'col-4';
                    div.innerHTML = `<img src="${e.target.result}" class="img-fluid rounded border" style="height: 70px; object-fit: cover; width: 100%;">`;
                    container.appendChild(div);
            }
                reader.readAsDataURL(file);
        });
    }
    }
</script>
{% endblock %}