{% extends 'core/base.html' %}
{% load static %}

{% block title %}{{ product.name }} - Organic Hub{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/product_detail.css' %}">
{% endblock %}

{% block content %}
<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;">
    <div id="cart-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-check-circle me-2 text-success"></i>
            <strong class="me-auto">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-message">
            <!-- Message will be inserted here -->
        </div>
    </div>
</div>

<div class="container-fluid mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/" class="text-decoration-none">Home</a></li>
            <li class="breadcrumb-item"><a href="/products/" class="text-decoration-none">Products</a></li>
            {% if product.category %}
                <li class="breadcrumb-item">
                    <a href="/products/?category={{ product.category.category_id }}" class="text-decoration-none">
                        {{ product.category.name }}
                    </a>
                </li>
            {% endif %}
            <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
        </ol>
    </nav>

    <!-- Product Detail -->
    <div class="row">
        <!-- Product Images Gallery -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm rounded-4">
                <div class="card-body p-3">
                    <!-- Main Image Display -->
                    <div class="position-relative mb-3 text-center">
                        <img id="main-image" 
                             src="{% if gallery_images %}{{ gallery_images.0.url }}{% elif product.get_primary_image %}{{ product.get_primary_image.url }}{% else %}/static/images/no-image.jpg{% endif %}" 
                             alt="{{ product.name }}" 
                             class="img-fluid rounded-3 square-image" 
                             style="width: 100%; max-width: 500px; margin: 0 auto; display: block; aspect-ratio: 1 / 1; object-fit: cover; object-position: center;">
                        
                        <!-- Image Counter -->
                        {% if gallery_images %}
                            <div class="position-absolute top-0 end-0 m-3">
                                <span class="badge bg-dark bg-opacity-75 fs-6">
                                    <i class="fas fa-images me-1"></i>
                                    <span id="current-image">1</span> / <span id="total-images">{{ gallery_images|length }}</span>
                                </span>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Thumbnail Gallery -->
                    {% if gallery_images %}
                        <div class="d-flex flex-wrap gap-2 justify-content-center" id="thumbnail-gallery">
                            {% for img in gallery_images %}
                                <div class="position-relative thumbnail-wrapper">
                                    <img src="{{ img.url }}" 
                                         alt="{{ img.alt }}" 
                                         class="img-fluid rounded-3 thumbnail-img {% if forloop.first %}active{% endif %}" 
                                         style="width: 80px; height: 80px; aspect-ratio: 1 / 1; object-fit: cover; object-position: center; cursor: pointer;"
                                         data-image-index="{{ img.index }}"
                                         data-image-type="{{ img.type }}"
                                         {% if img.variant_id %}data-variant-id="{{ img.variant_id }}"{% endif %}
                                         onclick="changeMainImage('{{ img.url }}', {{ img.index }}{% if img.variant_id %}, {{ img.variant_id }}{% endif %})">
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Product Info -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h2 class="mb-0">{{ product.name }}</h2>
                </div>
                <div class="card-body">
                    <!-- Variant Selector -->
                    {% if product.has_variants %}
                        {% if variants|length > 0 %}
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-tags me-1"></i>Select Variant:
                                </label>
                                <div class="btn-group-vertical w-100" role="group" id="variant-selector">
                                    {% for variant in variants %}
                                        <button type="button" 
                                                class="btn btn-outline-primary variant-btn {% if default_variant and variant.variant_id == default_variant.variant_id %}active{% endif %}" 
                                                data-variant-id="{{ variant.variant_id }}"
                                                data-variant-name="{{ variant.variant_name }}"
                                                data-variant-price="{{ variant.price }}"
                                                data-variant-image="{% if variant.image %}{{ variant.image.url }}{% elif variant.product.get_primary_image %}{{ variant.product.get_primary_image.url }}{% endif %}"
                                                data-variant-stock="{{ variant.stock }}">
                                            <div class="d-flex justify-content-between align-items-center w-100">
                                                <span>{{ variant.variant_name }}</span>
                                                <span class="badge bg-success">£{{ variant.price|floatformat:2 }}</span>
                                            </div>
                                            {% if variant.stock <= 0 %}
                                                <small class="text-danger d-block mt-1">Out of Stock</small>
                                            {% elif variant.stock < 10 %}
                                                <small class="text-warning d-block mt-1">{{ variant.stock }} left</small>
                                            {% endif %}
                                        </button>
                                    {% endfor %}
                                </div>
                                <input type="hidden" name="variant_id" id="selected-variant-id" value="{% if default_variant %}{{ default_variant.variant_id }}{% endif %}">
                            </div>
                        {% else %}
                            <div class="alert alert-warning mb-3">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                Sản phẩm này đang ở chế độ phân loại nhưng chưa có phân loại nào. Vui lòng liên hệ cửa hàng.
                            </div>
                        {% endif %}
                    {% endif %}
                    
                    <!-- Price -->
                    <div class="mb-3">
                        <h3 class="text-success fw-bold" id="product-price">
                            £{% if product.has_variants and default_variant %}
                                {{ default_variant.price|floatformat:2 }}
                            {% else %}
                                {{ product.display_price|floatformat:2 }}
                            {% endif %}
                        </h3>
                        {% if product.has_variants %}
                            <small class="text-muted">Price from £{{ product.min_price|floatformat:2 }} - £{{ product.max_price|floatformat:2 }}</small>
                        {% else %}
                            <small class="text-muted">Unit: {{ product.base_unit }}</small>
                        {% endif %}
                    </div>
                    
                    <!-- Product Details -->
                    <div class="row mb-3">
                        <div class="col-6">
                            <strong>Category:</strong><br>
                            <span class="badge bg-secondary">{{ product.category.name|default:"Uncategorized" }}</span>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <strong>Views:</strong><br>
                            <i class="fas fa-eye text-muted"></i> {{ product.view_count }}
                        </div>
                        <div class="col-6">
                            <strong>SKU:</strong><br>
                            <code>{{ product.SKU|default:"N/A" }}</code>
                        </div>
                    </div>
                    
                    <!-- Store Info -->
                    <div class="alert alert-info">
                        <h6 class="alert-heading mb-2">
                            <i class="fas fa-store"></i> {{ product.store.store_name }}
                        </h6>
                        {% if product.store.is_verified_status == 'verified' %}
                            <span class="badge bg-success">Verified</span>
                        {% elif product.store.is_verified_status == 'pending' %}
                            <span class="badge bg-warning">Pending Verification</span>
                        {% else %}
                            <span class="badge bg-danger">Rejected</span>
                        {% endif %}
                    </div>
                    
                    <!-- Actions -->
                    {% if user.is_authenticated %}
                        <form id="add-to-cart-form" method="post" action="{% url 'add_to_cart' product.product_id %}" class="mb-3">
                            {% csrf_token %}
                            <input type="hidden" name="variant_id" id="form-variant-id" value="{% if default_variant %}{{ default_variant.variant_id }}{% endif %}">
                            <div class="input-group mb-3">
                                <span class="input-group-text">Quantity:</span>
                                <input type="number" name="quantity" id="quantity-input" class="form-control" value="1" min="1" max="99">
                                <button type="submit" class="btn btn-success" id="add-to-cart-btn">
                                    <i class="fas fa-cart-plus"></i> Add to Cart
                                </button>
                            </div>
                            <div id="stock-message" class="text-muted small"></div>
                        </form>
                        
                        <div class="d-grid gap-2">
                            <a href="/cart/" class="btn btn-outline-primary">
                                <i class="fas fa-shopping-cart"></i> View Cart
                            </a>
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <h6 class="alert-heading">Login to Purchase</h6>
                            <p class="mb-2">You need to login to add products to cart.</p>
                            <a href="/login/" class="btn btn-primary btn-sm me-2">Login</a>
                            <a href="/register/" class="btn btn-outline-primary btn-sm">Register</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Product Description -->
    {% if product.description %}
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0"><i class="fas fa-info-circle"></i> Product Description</h4>
                </div>
                <div class="card-body">
                    <p class="mb-0">{{ product.description|linebreaks }}</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Chat Section -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0"><i class="fas fa-comments"></i> Contact Store</h4>
                </div>
                <div class="card-body">
                    {% if user.is_authenticated %}
                        <p>Have questions about this product? Chat directly with the store owner!</p>
                        <a href="#" 
                           class="btn btn-primary"
                           onclick="sendProductMessage('{{ product.name }}', '{{ product.store.user.user_id }}'); if(typeof openChatWidget === 'function') { openChatWidget({{ product.store.user.user_id }}); } else { document.getElementById('chatToggleBtn')?.click(); } return false;">
                            <i class="fas fa-comment-dots"></i> Chat with {{ product.store.store_name }}
                        </a>
                    {% else %}
                        <div class="alert alert-info">
                            <h6 class="alert-heading">Login to Chat</h6>
                            <p class="mb-2">You need to login to chat with the store.</p>
                            <a href="/login/" class="btn btn-primary btn-sm me-2">Login</a>
                            <a href="/register/" class="btn btn-outline-primary btn-sm">Register</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Reviews Section -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0"><i class="fas fa-star"></i> Product Reviews</h4>
                </div>
                <div class="card-body">
                    {% if reviews %}
                        {% for review in reviews %}
                        <div class="border-bottom pb-3 mb-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <div>
                                        {% for i in "12345" %}
                                            {% if forloop.counter <= review.rating %}
                                                <i class="fas fa-star text-warning"></i>
                                            {% else %}
                                                <i class="far fa-star text-warning"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between text-muted small mb-2">
                                <span><i class="fas fa-user"></i> {{ review.user.full_name }}</span>
                                <span><i class="fas fa-calendar"></i> {{ review.created_at|date:"d/m/Y H:i" }}</span>
                            </div>
                            <p class="mb-1">{{ review.content }}</p>
                            
                            {% if review.media_files.exists %}
                                <div class="mt-2 mb-2">
                                    {% for media in review.media_files.all %}
                                        {% if media.media_type == 'image' %}
                                            <img src="{{ media.file.url }}" alt="Review image" class="img-thumbnail me-2 mb-2 square-image" style="width: 150px; aspect-ratio: 1 / 1; object-fit: cover; object-position: center;">
                                        {% elif media.media_type == 'video' %}
                                            <video controls class="me-2 mb-2" style="max-height: 150px;">
                                                <source src="{{ media.file.url }}" type="video/mp4">
                                            </video>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            {% if review.has_seller_reply %}
                                <div class="alert alert-light mt-2 mb-0">
                                    <strong><i class="fas fa-store"></i> Store Reply:</strong>
                                    <p class="mb-0 mt-1">{{ review.seller_reply }}</p>
                                    <small class="text-muted">{{ review.seller_replied_at|date:"d/m/Y H:i" }}</small>
                                </div>
                            {% endif %}
                            
                            {% if review.is_verified_purchase %}
                                <small class="text-success">
                                    <i class="fas fa-check-circle"></i> Verified Purchase
                                </small>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-star fa-3x mb-3"></i>
                            <p>No reviews yet for this product.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Similar Products Section -->
    {% if similar_products %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between mb-4">
                <h3 class="fw-bold mb-0">Similar Products</h3>
                <a href="{% url 'product_list' %}" class="btn btn-outline-primary rounded-pill">
                    Xem tất cả <i class="fas fa-arrow-right ms-1"></i>
                </a>
            </div>
            <div class="row g-4">
                {% for product in similar_products %}
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-4 h-100 product-card-home">
                        <div class="position-relative">
                            {% if product.get_primary_image %}
                                <img src="{{ product.get_primary_image.url }}" 
                                     alt="{{ product.name }}" 
                                     class="card-img-top square-image" 
                                     style="width: 100%; aspect-ratio: 1 / 1; object-fit: cover; object-position: center;">
                            {% else %}
                                <img src="/static/images/no-image.jpg" 
                                     alt="{{ product.name }}" 
                                     class="card-img-top square-image" 
                                     style="width: 100%; aspect-ratio: 1 / 1; object-fit: cover; object-position: center;">
                            {% endif %}
                            <div class="position-absolute top-0 start-0 m-2">
                                <span class="badge bg-dark bg-opacity-75 rounded-pill">
                                    <i class="fas fa-eye me-1"></i>{{ product.view_count }}
                                </span>
                            </div>
                        </div>
                        <div class="card-body d-flex flex-column">
                            {% if product.category %}
                            <div class="mb-2">
                                <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill">
                                    {{ product.category.name }}
                                </span>
                            </div>
                            {% endif %}
                            <h5 class="card-title fw-bold mb-2">
                                <a href="{% url 'product_detail' product.product_id %}" 
                                   class="text-decoration-none text-dark stretched-link">
                                    {{ product.name|truncatechars:50 }}
                                </a>
                            </h5>
                            <div class="mb-3">
                                <span class="h5 fw-bold text-success mb-0">
                                    £{{ product.display_price|floatformat:2 }}
                                </span>
                            </div>
                            {% if product.description %}
                                <p class="card-text text-muted small flex-grow-1">
                                    {{ product.description|truncatewords:15 }}
                                </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Frequently Bought Together Section -->
    {% if frequently_bought_together %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between mb-4">
                <h3 class="fw-bold mb-0">Frequently Bought Together</h3>
            </div>
            <div class="row g-4">
                {% for product in frequently_bought_together %}
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-4 h-100 product-card-home">
                        <div class="position-relative">
                            {% if product.get_primary_image %}
                                <img src="{{ product.get_primary_image.url }}" 
                                     alt="{{ product.name }}" 
                                     class="card-img-top square-image" 
                                     style="width: 100%; aspect-ratio: 1 / 1; object-fit: cover; object-position: center;">
                            {% else %}
                                <img src="/static/images/no-image.jpg" 
                                     alt="{{ product.name }}" 
                                     class="card-img-top square-image" 
                                     style="width: 100%; aspect-ratio: 1 / 1; object-fit: cover; object-position: center;">
                            {% endif %}
                            <div class="position-absolute top-0 start-0 m-2">
                                <span class="badge bg-dark bg-opacity-75 rounded-pill">
                                    <i class="fas fa-eye me-1"></i>{{ product.view_count }}
                                </span>
                            </div>
                        </div>
                        <div class="card-body d-flex flex-column">
                            {% if product.category %}
                            <div class="mb-2">
                                <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill">
                                    {{ product.category.name }}
                                </span>
                            </div>
                            {% endif %}
                            <h5 class="card-title fw-bold mb-2">
                                <a href="{% url 'product_detail' product.product_id %}" 
                                   class="text-decoration-none text-dark stretched-link">
                                    {{ product.name|truncatechars:50 }}
                                </a>
                            </h5>
                            <div class="mb-3">
                                <span class="h5 fw-bold text-success mb-0">
                                    £{{ product.display_price|floatformat:2 }}
                                </span>
                            </div>
                            {% if product.description %}
                                <p class="card-text text-muted small flex-grow-1">
                                    {{ product.description|truncatewords:15 }}
                                </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'core/js/product_detail.js' %}"></script>
{% if product.has_variants and variants and default_variant %}
<script>
    // Initialize stock message for default variant
    document.addEventListener('DOMContentLoaded', function() {
        const defaultBtn = document.querySelector('.variant-btn.active');
        if (defaultBtn && typeof handleVariantSelection === 'function') {
            handleVariantSelection(defaultBtn);
        }
    });
</script>
{% endif %}
{% endblock %}