{% extends 'core/base.html' %}
{% load humanize %}
{% block title %}Cart - Organic Hub{% endblock %}
{% block extra_css %}
<style>
    /* Keep only necessary CSS that Bootstrap doesn't support by default */
    body { background-color: #f8f9fa; }
    
    .cart-container { padding-bottom: 120px; /* Avoid footer overlap */ }
    
    .product-img {
        width: 80px; height: 80px; object-fit: cover; border-radius: 6px;
    }
    
    .quantity-input {
        width: 50px; text-align: center; border-left: 0; border-right: 0;
    }
    
    /* Sticky Header cho Desktop */
    .sticky-header {
        position: sticky; top: 0; z-index: 980;
    }
    .sticky-footer {
        box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
    }
    .chat-widget {
        display: none !important;
    }
    a { text-decoration: none; color: inherit; }
    a:hover { color: var(--bs-primary); }
</style>
{% endblock %}
{% block content %}
<div class="container cart-container mt-4">
    {% if stores_dict %}
        <!-- Header Row (Hidden on Mobile) -->
        <div class="card mb-3 shadow-sm border-0 sticky-header d-none d-md-block">
            <div class="card-body py-3">
                <div class="row align-items-center text-muted fw-bold fs-6">
                    <div class="col-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            <label class="form-check-label ms-2" for="selectAll">Product</label>
                        </div>
                    </div>
                    <div class="col-2 text-center">Unit Price</div>
                    <div class="col-2 text-center">Quantity</div>
                    <div class="col-1 text-center">Total</div>
                    <div class="col-1 text-end">Action</div>
                </div>
            </div>
        </div>
        <form id="checkoutForm" method="post" action="{% url 'checkout_select' %}"> 
            {% csrf_token %}
            <input type="hidden" name="applied_discounts" id="appliedDiscountsField" value="">
        <!-- Store Loop -->
        {% for store_id, store_data in stores_dict.items %}
        <div class="card mb-3 shadow-sm border-0 store-section" data-store-id="{{ store_id }}">
            <!-- Store Header -->
            <div class="card-header bg-white border-bottom py-3">
                <div class="form-check d-flex align-items-center">
                    <input class="form-check-input store-checkbox" type="checkbox" 
                           data-store-id="{{ store_id }}" onchange="toggleStoreItems(this)">
                    <a href="#" class="ms-2 fw-bold text-dark fs-5">
                        <i class="fas fa-store me-1 text-secondary"></i> {{ store_data.store.store_name }}
                    </a>
                </div>
            </div>
            <!-- Products List -->
            <div class="list-group list-group-flush">
                {% for item in store_data.items %}
                <div class="list-group-item py-3 product-item" data-item-id="{{ item.cart_item_id }}">
                    <div class="row align-items-center">
                        <!-- Product Info (Col-6 on Desktop, Col-12 on Mobile) -->
                        <div class="col-12 col-md-6 mb-3 mb-md-0">
                            <div class="d-flex align-items-center">
                                <input class="form-check-input me-3 item-checkbox" 
                                        type="checkbox" 
                                        name="selected_items"
                                        value="{{ item.cart_item_id }}"
                                       data-item-id="{{ item.cart_item_id }}" 
                                       data-store-id="{{ store_id }}" 
                                       onchange="updateTotal()">
                                
                                <img src="{% if item.product.get_primary_image %}{{ item.product.get_primary_image.url }}{% else %}/static/images/no-image.jpg{% endif %}" 
                                     class="product-img border me-3">
                                
                                <div>
                                    <a href="{% url 'product_detail' item.product.product_id %}" class="text-truncate-2 mb-1 d-block">
                                        {{ item.product.name|truncatechars:60 }}
                                    </a>
                                    <small class="text-muted d-block">
                                        {% if item.variant %}Variant: {{ item.variant.variant_name }}{% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                        <!-- Unit Price -->
                        <div class="col-4 col-md-2 text-center text-md-center">
                            <span class="d-md-none text-muted small">Unit Price: </span>
                            £{{ item.unit_price|floatformat:2|intcomma }}
                        </div>
                        <!-- Quantity -->
                        <div class="col-4 col-md-2 d-flex justify-content-center">
                            <div class="input-group input-group-sm" style="width: 110px;">
                                <button class="btn btn-outline-secondary quantity-decrease" 
                                        data-item-id="{{ item.cart_item_id }}" 
                                        data-change="-1">-</button>
                                <input type="number" class="form-control quantity-input" 
                                       value="{{ item.quantity }}" 
                                       min="1" max="99" 
                                       data-item-id="{{ item.cart_item_id }}">
                                <button class="btn btn-outline-secondary quantity-increase" 
                                        data-item-id="{{ item.cart_item_id }}" 
                                        data-change="1">+</button>
                            </div>
                        </div>
                        <!-- Total Amount & Delete (Combined on Mobile) -->
                        <div class="col-4 col-md-1 text-center text-danger fw-bold amount-display" data-item-id="{{ item.cart_item_id }}" data-store-id="{{ store_id }}">
                            <!-- Original Price (shown by default) -->
                            <div class="original-item-price">
                                £{{ item.total_price|floatformat:2|intcomma }}
                            </div>
                            <!-- Discounted Price (hidden by default) -->
                            <div class="discounted-item-price" style="display: none;">
                                <div class="text-muted text-decoration-line-through small original-price-display mb-1"></div>
                                <div class="text-danger fw-bold final-price-display"></div>
                            </div>
                            <!-- Hidden raw value for JS calculation -->
                            <span class="d-none amount-raw">{{ item.total_price }}</span>
                        </div>
                        <div class="col-12 col-md-1 text-end mt-2 mt-md-0">
                            <button class="btn btn-link text-danger p-0 text-decoration-none small remove-item-btn" 
                                    data-item-id="{{ item.cart_item_id }}">Delete</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Shop Voucher -->
            <div class="card-footer bg-light py-2">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center text-primary small cursor-pointer show-vouchers-btn" 
                         data-store-id="{{ store_id }}">
                        <i class="fas fa-ticket-alt me-2"></i>
                        <span>Add Shop Discount Code</span>
                    </div>
                    <div id="applied-discount-{{ store_id }}" class="text-success small" style="display: none;">
                        <i class="fas fa-check-circle me-1"></i>
                        <span id="applied-discount-text-{{ store_id }}"></span>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        <!-- Fixed Bottom Footer -->
        <div class="fixed-bottom bg-white sticky-footer border-top p-3">
            <div class="container">
                <div class="row align-items-center justify-content-between">
                    <!-- Left: Select All & Delete -->
                    <div class="col-12 col-md-6 mb-2 mb-md-0 d-flex align-items-center justify-content-between justify-content-md-start">
                        <div class="form-check me-4">
                            <input class="form-check-input" type="checkbox" id="selectAllFooter" onchange="toggleSelectAll()">
                            <label class="form-check-label" for="selectAllFooter">Select All (<span id="selectedCount">0</span>)</label>
                        </div>
                        <button class="btn btn-link text-danger text-decoration-none p-0" onclick="deleteSelected()">Delete Selected</button>
                    </div>
                    <!-- Right: Total & Buy Button -->
                    <div class="col-12 col-md-6 d-flex align-items-center justify-content-between justify-content-md-end gap-3">
                        <div class="text-end">
                            <div class="text-muted small">Total Payment (<span id="totalItems">0</span> items):</div>
                            <div class="text-muted small text-decoration-line-through" id="originalTotalAmount" style="display: none;">£0.00</div>
                            <div id="discountInfo" class="text-success small mb-1" style="display: none;">
                                <i class="fas fa-tag me-1"></i>Discount: -<span id="discountAmount">£0.00</span>
                            </div>
                            <div class="text-danger fs-4 fw-bold" id="totalAmount">£0.00</div>
                        </div>
                        <button class="btn btn-danger px-4 py-2 fw-bold" id="buyButton" type="submit" disabled>
                                Checkout
                        </button>
                    </div>
                </div>
            </div>
        </div>
        </form>
    {% else %}
        <!-- Empty Cart -->
        <div class="text-center py-5">
            <div class="mb-4">
                <i class="fas fa-shopping-cart fa-4x text-muted opacity-25"></i>
            </div>
            <h4 class="text-muted mb-3">Your cart is empty</h4>
            <a href="{% url 'product_list' %}" class="btn btn-primary">
                <i class="fas fa-arrow-left me-2"></i>Continue Shopping
            </a>
        </div>
    {% endif %}
    <!-- Recommendations Section -->
    {% if recommendations %}
    <div class="row mt-5 mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between mb-4">
                <h3 class="fw-bold mb-0">You May Also Like</h3>
                <a href="{% url 'product_list' %}" class="btn btn-outline-primary rounded-pill">
                    View All <i class="fas fa-arrow-right ms-1"></i>
                </a>
            </div>
            <div class="row g-4">
                {% for product in recommendations %}
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-4 h-100 product-card-home">
                        <div class="position-relative">
                            {% if product.get_primary_image %}
                                <img src="{{ product.get_primary_image.url }}" 
                                     alt="{{ product.name }}" 
                                     class="card-img-top square-image" 
                                     style="width: 100%; aspect-ratio: 1 / 1; object-fit: cover; object-position: center;">
                            {% else %}
                                <img src="/static/images/no-image.jpg" 
                                     alt="{{ product.name }}" 
                                     class="card-img-top square-image" 
                                     style="width: 100%; aspect-ratio: 1 / 1; object-fit: cover; object-position: center;">
                            {% endif %}
                            <div class="position-absolute top-0 start-0 m-2">
                                <span class="badge bg-dark bg-opacity-75 rounded-pill">
                                    <i class="fas fa-eye me-1"></i>{{ product.view_count }}
                                </span>
                            </div>
                        </div>
                        <div class="card-body d-flex flex-column">
                            {% if product.category %}
                            <div class="mb-2">
                                <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill">
                                    {{ product.category.name }}
                                </span>
                            </div>
                            {% endif %}
                            <h5 class="card-title fw-bold mb-2">
                                <a href="{% url 'product_detail' product.product_id %}" 
                                   class="text-decoration-none text-dark stretched-link">
                                    {{ product.name|truncatechars:50 }}
                                </a>
                            </h5>
                            <div class="mb-3">
                                <span class="h5 fw-bold text-success mb-0">
                                    £{{ product.min_price|floatformat:2 }}
                                </span>
                            </div>
                            {% if product.description %}
                                <p class="card-text text-muted small flex-grow-1">
                                    {{ product.description|truncatewords:15 }}
                                </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
<!-- Discount Code Modal -->
<div class="modal fade" id="discountCodeModal" tabindex="-1" aria-labelledby="discountCodeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="discountCodeModalLabel">
                    <i class="fas fa-ticket-alt me-2 text-primary"></i>Available Discount Codes
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="discountCodeList" class="list-group">
                    <!-- Discount codes will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% csrf_token %}
{% load static %}
{% block extra_js %}
<!-- Cart JavaScript Modules -->
<script src="{% static 'core/js/cart/cart-utils.js' %}"></script>
<script src="{% static 'core/js/cart/cart-discount.js' %}"></script>
<script src="{% static 'core/js/cart/cart-ui.js' %}"></script>
<script src="{% static 'core/js/cart/cart-events.js' %}"></script>
<script src="{% static 'core/js/cart/cart.js' %}"></script>
{% endblock %}