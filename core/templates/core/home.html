{% extends 'core/base.html' %}

{% block title %}Trang chủ - Organic Hub{% endblock %}

{% block extra_css %}
<style>
    /* Home Page Styles */
    .category-card {
        transition: all 0.3s ease;
        cursor: pointer;
        border: 2px solid transparent;
    }

    .category-card:hover {
        transform: translateY(-5px);
        border-color: var(--organic-primary);
        box-shadow: 0 0.5rem 1rem rgba(40, 167, 69, 0.15);
    }

    .category-icon {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, var(--organic-primary) 0%, var(--organic-primary-dark) 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        margin: 0 auto 1rem;
    }

    .product-card-home {
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .product-card-home:hover {
        transform: translateY(-8px);
        box-shadow: 0 0.75rem 1.5rem rgba(40, 167, 69, 0.2) !important;
    }

    .product-card-home:hover .card-img-top {
        transform: scale(1.05);
    }

    .product-card-home .card-img-top {
        transition: transform 0.3s ease;
    }

    .product-card-home .position-relative {
        overflow: hidden;
        border-radius: 1rem 1rem 0 0;
    }

    .product-card-home:hover .card-title a {
        color: var(--organic-primary) !important;
    }

    .product-card-home .badge.bg-primary.bg-opacity-10 {
        background-color: rgba(40, 167, 69, 0.15) !important;
        color: var(--organic-primary-dark) !important;
        font-weight: 500;
        padding: 0.4em 0.8em;
        border: 1px solid rgba(40, 167, 69, 0.2);
    }

    /* Floating Chat Widget */
    .chat-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1050;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .chat-button {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--organic-primary) 0%, var(--organic-primary-dark) 100%);
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .chat-button:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(40, 167, 69, 0.5);
    }

    .chat-button .badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: #dc3545;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: bold;
    }

    .chat-window {
        position: absolute;
        bottom: 80px;
        right: 0;
        width: 380px;
        height: 600px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        display: none;
        flex-direction: column;
        overflow: hidden;
    }

    .chat-window.active {
        display: flex;
    }

    .chat-window.minimized {
        height: 400px;
    }

    .chat-header {
        background: linear-gradient(135deg, var(--organic-primary) 0%, var(--organic-primary-dark) 100%);
        color: white;
        padding: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-radius: 16px 16px 0 0;
    }

    .chat-header h6 {
        margin: 0;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .chat-header-actions {
        display: flex;
        gap: 0.5rem;
    }

    .chat-header-actions button {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .chat-header-actions button:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .chat-search-filter {
        padding: 1rem;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }

    .chat-search-input {
        width: 100%;
        padding: 0.5rem 1rem;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
    }

    .chat-filter-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .chat-filter-btn {
        flex: 1;
        padding: 0.5rem;
        border: 1px solid #dee2e6;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.2s;
    }

    .chat-filter-btn.active {
        background: var(--organic-primary);
        color: white;
        border-color: var(--organic-primary);
    }

    .chat-list {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
    }

    .chat-item {
        padding: 0.75rem;
        border-radius: 8px;
        cursor: pointer;
        margin-bottom: 0.5rem;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .chat-item:hover {
        background: #f8f9fa;
    }

    .chat-item.active {
        background: var(--organic-light);
    }

    .chat-item-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
    }

    .chat-item-avatar-placeholder {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--organic-light);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--organic-primary);
        font-size: 1.2rem;
        flex-shrink: 0;
    }

    .chat-item-content {
        flex: 1;
        min-width: 0;
    }

    .chat-item-name {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
        color: #212529;
    }

    .chat-item-message {
        font-size: 0.85rem;
        color: #6c757d;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .chat-item-time {
        font-size: 0.75rem;
        color: #adb5bd;
        margin-top: 0.25rem;
    }

    .chat-item-badge {
        background: #dc3545;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: bold;
        flex-shrink: 0;
    }

    .chat-detail {
        display: none;
        flex-direction: column;
        height: 100%;
    }

    .chat-detail.active {
        display: flex;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background: #f8f9fa;
    }

    .chat-message {
        margin-bottom: 1rem;
        display: flex;
        flex-direction: column;
    }

    .chat-message.sent {
        align-items: flex-end;
    }

    .chat-message.received {
        align-items: flex-start;
    }

    .chat-message-bubble {
        max-width: 70%;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        word-wrap: break-word;
    }

    .chat-message.sent .chat-message-bubble {
        background: var(--organic-primary);
        color: white;
    }

    .chat-message.received .chat-message-bubble {
        background: white;
        color: #212529;
        border: 1px solid #dee2e6;
    }

    .chat-message-time {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }

    .chat-input-area {
        padding: 1rem;
        background: white;
        border-top: 1px solid #dee2e6;
        display: flex;
        gap: 0.5rem;
    }

    .chat-input {
        flex: 1;
        padding: 0.75rem;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        font-size: 0.9rem;
    }

    .chat-send-btn {
        padding: 0.75rem 1.5rem;
        background: var(--organic-primary);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.2s;
    }

    .chat-send-btn:hover {
        background: var(--organic-primary-dark);
    }

    @media (max-width: 768px) {
        .chat-window {
            width: 100vw;
            height: 100vh;
            bottom: 0;
            right: 0;
            border-radius: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Categories Section -->
    {% if categories %}
    <div class="row mb-5">
        <div class="col-12">
            <h2 class="fw-bold mb-4">Danh mục sản phẩm</h2>
            <div class="row g-3">
                {% for category in categories %}
                <div class="col-lg-2 col-md-3 col-sm-4 col-6">
                    <a href="{% url 'product_list' %}?category={{ category.category_id }}" 
                       class="text-decoration-none text-dark">
                        <div class="card border-0 shadow-sm rounded-4 category-card h-100 text-center p-3">
                            <div class="category-icon">
                                <i class="fas fa-leaf"></i>
                            </div>
                            <h6 class="mb-0 fw-semibold">{{ category.name }}</h6>
                        </div>
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Suggested Products Section -->
    {% if suggested_products %}
    <div class="row mb-5">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between mb-4">
                <h2 class="fw-bold mb-0">Gợi ý sản phẩm</h2>
                <a href="{% url 'product_list' %}" class="btn btn-outline-primary rounded-pill">
                    Xem tất cả <i class="fas fa-arrow-right ms-1"></i>
                </a>
            </div>
            <div class="row g-4">
                {% for product in suggested_products %}
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <div class="card border-0 shadow-sm rounded-4 h-100 product-card-home">
                        <!-- Product Image -->
                        <div class="position-relative">
                            {% if product.get_primary_image %}
                                <img src="{{ product.get_primary_image.url }}" 
                                     alt="{{ product.name }}" 
                                     class="card-img-top square-image" 
                                     style="width: 100%; aspect-ratio: 1 / 1; object-fit: cover; object-position: center;">
                            {% else %}
                                <img src="/static/images/no-image.jpg" 
                                     alt="{{ product.name }}" 
                                     class="card-img-top square-image" 
                                     style="width: 100%; aspect-ratio: 1 / 1; object-fit: cover; object-position: center;">
                            {% endif %}
                            
                            <!-- View Count -->
                            <div class="position-absolute top-0 start-0 m-2">
                                <span class="badge bg-dark bg-opacity-75 rounded-pill">
                                    <i class="fas fa-eye me-1"></i>{{ product.view_count }}
                                </span>
                            </div>
                        </div>
                        
                        <!-- Product Info -->
                        <div class="card-body d-flex flex-column">
                            <!-- Category Badge -->
                            <div class="mb-2">
                                <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill">
                                    {{ product.category.name|default:"Chưa phân loại" }}
                                </span>
                            </div>
                            
                            <!-- Product Title -->
                            <h5 class="card-title fw-bold mb-2">
                                <a href="{% url 'product_detail' product.product_id %}" 
                                   class="text-decoration-none text-dark stretched-link">
                                    {{ product.name|truncatechars:50 }}
                                </a>
                            </h5>
                            
                            <!-- Price -->
                            <div class="mb-3">
                                <span class="h5 fw-bold text-success mb-0">
                                    {{ product.price|floatformat:0 }} VNĐ
                                </span>
                            </div>
                            
                            <!-- Description -->
                            {% if product.description %}
                                <p class="card-text text-muted small flex-grow-1">
                                    {{ product.description|truncatewords:15 }}
                                </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Floating Chat Widget -->
{% if user.is_authenticated %}
<div class="chat-widget" id="chatWidget">
    <button class="chat-button" id="chatToggleBtn">
        <i class="fas fa-comments"></i>
        <span class="badge" id="unreadBadge" style="display: none;">0</span>
    </button>
    
    <div class="chat-window" id="chatWindow">
        <!-- Chat List View -->
        <div class="chat-list-view" id="chatListView" style="display: flex; flex-direction: column; height: 100%;">
            <div class="chat-header">
                <h6>
                    <i class="fas fa-comments"></i>
                    Chat (<span id="chatCount">0</span>)
                </h6>
                <div class="chat-header-actions">
                    <button id="minimizeBtn" title="Thu nhỏ">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button id="closeBtn" title="Đóng">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="chat-search-filter">
                <input type="text" 
                       class="chat-search-input" 
                       id="chatSearchInput" 
                       placeholder="Tìm theo tên...">
                <div class="chat-filter-buttons">
                    <button class="chat-filter-btn active" data-filter="all">Tất cả</button>
                    <button class="chat-filter-btn" data-filter="unread">Chưa đọc</button>
                </div>
            </div>
            
            <div class="chat-list" id="chatList">
                <div class="text-center text-muted py-4">
                    <i class="fas fa-spinner fa-spin"></i> Đang tải...
                </div>
            </div>
        </div>
        
        <!-- Chat Detail View -->
        <div class="chat-detail" id="chatDetailView">
            <div class="chat-header">
                <h6>
                    <button id="backToListBtn" style="background: none; border: none; color: white; margin-right: 0.5rem; cursor: pointer;">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <span id="chatDetailName">Chat</span>
                </h6>
                <div class="chat-header-actions">
                    <button id="minimizeDetailBtn" title="Thu nhỏ">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button id="closeDetailBtn" title="Đóng">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="text-center text-muted py-4">
                    Chọn một cuộc trò chuyện để xem tin nhắn
                </div>
            </div>
            
            <div class="chat-input-area">
                <input type="text" 
                       class="chat-input" 
                       id="chatMessageInput" 
                       placeholder="Nhập nội dung tin nhắn...">
                <button class="chat-send-btn" id="chatSendBtn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{% if user.is_authenticated %}
<script>
    // Chat Widget State
    let chatState = {
        isOpen: false,
        isMinimized: false,
        currentView: 'list', // 'list' or 'detail'
        currentRoom: null,
        currentUserId: null,
        currentOtherUserId: null,
        currentIsBot: false,  // Track if current room is bot room
        filter: 'all',
        searchQuery: '',
        chatRooms: [],
        chatSocket: null
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        chatState.currentUserId = {{ user.user_id }};
        loadChatRooms();
        setupEventListeners();
    });

    // Setup Event Listeners
    function setupEventListeners() {
        // Toggle chat window
        document.getElementById('chatToggleBtn').addEventListener('click', toggleChatWindow);
        
        // Close buttons
        document.getElementById('closeBtn').addEventListener('click', closeChatWindow);
        document.getElementById('closeDetailBtn').addEventListener('click', closeChatWindow);
        
        // Minimize buttons
        document.getElementById('minimizeBtn').addEventListener('click', minimizeChatWindow);
        document.getElementById('minimizeDetailBtn').addEventListener('click', minimizeChatWindow);
        
        // Back to list
        document.getElementById('backToListBtn').addEventListener('click', showChatList);
        
        // Search input
        document.getElementById('chatSearchInput').addEventListener('input', handleSearch);
        
        // Filter buttons
        document.querySelectorAll('.chat-filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.chat-filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                chatState.filter = this.dataset.filter;
                renderChatList();
            });
        });
        
        // Send message
        document.getElementById('chatSendBtn').addEventListener('click', sendMessage);
        document.getElementById('chatMessageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    }

    // Toggle Chat Window
    function toggleChatWindow() {
        chatState.isOpen = !chatState.isOpen;
        const chatWindow = document.getElementById('chatWindow');
        if (chatState.isOpen) {
            chatWindow.classList.add('active');
            loadChatRooms();
        } else {
            chatWindow.classList.remove('active');
        }
    }

    // Close Chat Window
    function closeChatWindow() {
        chatState.isOpen = false;
        document.getElementById('chatWindow').classList.remove('active');
        
        // Close WebSocket connection
        if (chatState.chatSocket) {
            chatState.chatSocket.close();
            chatState.chatSocket = null;
        }
        
        showChatList();
    }

    // Minimize Chat Window
    function minimizeChatWindow() {
        chatState.isMinimized = !chatState.isMinimized;
        const chatWindow = document.getElementById('chatWindow');
        if (chatState.isMinimized) {
            chatWindow.classList.add('minimized');
        } else {
            chatWindow.classList.remove('minimized');
        }
    }

    // Show Chat List
    function showChatList() {
        chatState.currentView = 'list';
        chatState.currentRoom = null;
        chatState.currentOtherUserId = null;
        chatState.currentIsBot = false;
        
        // Close WebSocket connection
        if (chatState.chatSocket) {
            chatState.chatSocket.close();
            chatState.chatSocket = null;
        }
        
        document.getElementById('chatListView').style.display = 'flex';
        document.getElementById('chatDetailView').classList.remove('active');
    }

    // Show Chat Detail
    function showChatDetail(roomName, otherUser, isBot = false) {
        console.log('showChatDetail called', roomName, otherUser, 'isBot:', isBot);
        
        if (!roomName || !otherUser) {
            console.error('Missing roomName or otherUser', { roomName, otherUser });
            return;
        }
        
        chatState.currentView = 'detail';
        chatState.currentRoom = roomName;
        chatState.currentOtherUserId = otherUser.user_id;
        chatState.currentIsBot = isBot || false;  // Lưu thông tin bot room
        
        // Hide list view and show detail view
        document.getElementById('chatListView').style.display = 'none';
        document.getElementById('chatDetailView').classList.add('active');
        document.getElementById('chatDetailName').textContent = otherUser.full_name || otherUser.phone_number || 'Người dùng';
        
        // Clear previous messages and show loading
        document.getElementById('chatMessages').innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-spinner fa-spin"></i> Đang tải tin nhắn...</div>';
        
        // Load messages
        loadChatMessages(roomName);
        
        // Connect WebSocket for real-time messaging
        connectWebSocket(roomName);
    }

    // Load Chat Rooms
    function loadChatRooms() {
        fetch('{% url "chat_rooms_api" %}')
            .then(response => response.json())
            .then(data => {
                chatState.chatRooms = data.chat_rooms.map(room => ({
                    userId: room.other_user.user_id,
                    name: room.other_user.full_name,
                    phoneNumber: room.other_user.phone_number,
                    avatar: room.other_user.avatar,
                    lastMessage: room.last_message.content,
                    time: formatTime(room.last_message.created_at),
                    roomName: room.room_name,
                    unreadCount: room.unread_count,
                    isBot: room.is_bot || false  // Lưu thông tin bot room
                }));
                
                renderChatList();
                updateUnreadBadge(data.total_unread);
            })
            .catch(error => {
                console.error('Error loading chat rooms:', error);
                document.getElementById('chatList').innerHTML = 
                    '<div class="text-center text-muted py-4">Lỗi khi tải danh sách chat</div>';
            });
    }
    
    // Format time
    function formatTime(isoString) {
        const date = new Date(isoString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return 'Vừa xong';
        if (diffMins < 60) return `${diffMins} phút`;
        if (diffHours < 24) return `${diffHours} giờ`;
        if (diffDays < 7) return `${diffDays} ngày`;
        
        return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
    }

    // Render Chat List
    function renderChatList() {
        const chatList = document.getElementById('chatList');
        let filteredRooms = chatState.chatRooms;
        
        // Apply search filter
        if (chatState.searchQuery) {
            filteredRooms = filteredRooms.filter(room => 
                room.name.toLowerCase().includes(chatState.searchQuery.toLowerCase())
            );
        }
        
        // Apply read/unread filter
        if (chatState.filter === 'unread') {
            filteredRooms = filteredRooms.filter(room => room.unreadCount > 0);
        }
        
        if (filteredRooms.length === 0) {
            chatList.innerHTML = '<div class="text-center text-muted py-4">Không có cuộc trò chuyện nào</div>';
            return;
        }
        
        chatList.innerHTML = filteredRooms.map((room, index) => {
            const avatarHtml = room.avatar 
                ? `<img src="${room.avatar}" class="chat-item-avatar" alt="${room.name}">`
                : `<div class="chat-item-avatar-placeholder"><i class="fas fa-user"></i></div>`;
            
            // Store room data in a way that can be accessed by onclick
            const roomDataId = `room_${index}_${Date.now()}`;
            window[roomDataId] = {
                roomName: room.roomName,
                otherUser: {
                    full_name: room.name,
                    user_id: room.userId,
                    phone_number: room.phoneNumber || ''
                },
                isBot: room.isBot || false  // Lưu thông tin bot room
            };
            
            return `
                <div class="chat-item" onclick="handleChatItemClick('${roomDataId}')">
                    ${avatarHtml}
                    <div class="chat-item-content">
                        <div class="chat-item-name">${escapeHtml(room.name)}${room.unreadCount > 0 ? ` <span class="chat-item-badge">${room.unreadCount}</span>` : ''}</div>
                        <div class="chat-item-message">${escapeHtml(room.lastMessage)}</div>
                        <div class="chat-item-time">${room.time}</div>
                    </div>
                </div>
            `;
        }).join('');
        
        document.getElementById('chatCount').textContent = filteredRooms.length;
    }

    // Handle Search
    function handleSearch(e) {
        chatState.searchQuery = e.target.value;
        renderChatList();
    }

    // Load Chat Messages
    function loadChatMessages(roomName) {
        // Extract user ID from room name
        const parts = roomName.split('_');
        if (parts.length < 3) {
            console.error('Invalid room name format:', roomName);
            document.getElementById('chatMessages').innerHTML = 
                '<div class="text-center text-muted py-4">Lỗi: Định dạng phòng chat không hợp lệ</div>';
            return;
        }
        
        const userId1 = parseInt(parts[1]);
        const userId2 = parseInt(parts[2]);
        const otherUserId = userId1 === chatState.currentUserId ? userId2 : userId1;
        
        console.log('Loading messages for room:', roomName, 'otherUserId:', otherUserId);
        
        fetch(`/chat/api/messages/${otherUserId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Messages loaded:', data);
                const chatMessages = document.getElementById('chatMessages');
                
                if (!data.messages || data.messages.length === 0) {
                    chatMessages.innerHTML = '<div class="text-center text-muted py-4">Chưa có tin nhắn nào</div>';
                    return;
                }
                
                chatMessages.innerHTML = data.messages.map(msg => {
                    const isSent = msg.sender_id === chatState.currentUserId;
                    const time = new Date(msg.created_at).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                    
                    return `
                        <div class="chat-message ${isSent ? 'sent' : 'received'}">
                            <div class="chat-message-bubble">${escapeHtml(msg.content)}</div>
                            <div class="chat-message-time">${escapeHtml(msg.sender_name)} - ${time}</div>
                        </div>
                    `;
                }).join('');
                
                // Scroll to bottom
                setTimeout(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 100);
            })
            .catch(error => {
                console.error('Error loading messages:', error);
                document.getElementById('chatMessages').innerHTML = 
                    '<div class="text-center text-muted py-4">Lỗi khi tải tin nhắn: ' + escapeHtml(error.message) + '</div>';
            });
    }
    
    // Escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Connect WebSocket
    function connectWebSocket(roomName) {
        // Close existing connection if any
        if (chatState.chatSocket) {
            chatState.chatSocket.close();
            chatState.chatSocket = null;
        }
        
        // Create new WebSocket connection
        // Sử dụng đúng URL cho bot room hoặc normal chat
        const isBot = chatState.currentIsBot || false;
        const wsPath = isBot ? '/ws/chat/bot/' : '/ws/chat/private/';
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}${wsPath}${roomName}/`;
        
        console.log('Connecting to WebSocket:', wsUrl);
        console.log('Is bot room:', isBot);
        
        chatState.chatSocket = new WebSocket(wsUrl);
        
        chatState.chatSocket.onopen = function(e) {
            console.log('WebSocket connected successfully for room:', roomName);
        };
        
        chatState.chatSocket.onmessage = function(e) {
            try {
                const data = JSON.parse(e.data);
                console.log('Received WebSocket message:', data);
                
                // Add message to chat UI (only if from other user, or from bot)
                const isFromBot = data.is_bot || false;
                const isBotRoom = chatState.currentIsBot || false;
                if (data.sender_id && (data.sender_id !== chatState.currentUserId || isBotRoom)) {
                    addMessageToChat(data.message, data.username || 'Bot', false, data.sender_id);
                }
            } catch (error) {
                console.error('Error parsing WebSocket message:', error);
                console.error('Raw data:', e.data);
            }
        };
        
        chatState.chatSocket.onerror = function(error) {
            console.error('WebSocket error:', error);
        };
        
        chatState.chatSocket.onclose = function(e) {
            console.log('WebSocket closed', e.code, e.reason);
        };
    }
    
    // Add message to chat UI
    function addMessageToChat(content, senderName, isSent, senderId) {
        const chatMessages = document.getElementById('chatMessages');
        
        // Remove "no messages" placeholder if exists
        const placeholder = chatMessages.querySelector('.text-center.text-muted');
        if (placeholder) {
            placeholder.remove();
        }
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${isSent ? 'sent' : 'received'}`;
        
        const time = new Date().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        
        messageDiv.innerHTML = `
            <div class="chat-message-bubble">${escapeHtml(content)}</div>
            <div class="chat-message-time">${senderName} - ${time}</div>
        `;
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Send Message
    function sendMessage() {
        const input = document.getElementById('chatMessageInput');
        const message = input.value.trim();
        
        if (!message) {
            return;
        }
        
        if (!chatState.currentRoom) {
            console.error('No current room selected');
            alert('Vui lòng chọn một cuộc trò chuyện');
            return;
        }
        
        // Show message immediately in UI
        addMessageToChat(message, 'Bạn', true, chatState.currentUserId);
        
        // Send via WebSocket
        if (chatState.chatSocket && chatState.chatSocket.readyState === WebSocket.OPEN) {
            console.log('Sending message via WebSocket:', message);
            chatState.chatSocket.send(JSON.stringify({
                'message': message
            }));
        } else {
            console.warn('WebSocket is not connected, attempting to reconnect...');
            // Try to reconnect
            connectWebSocket(chatState.currentRoom);
            
            // Wait a bit and try again
            setTimeout(() => {
                if (chatState.chatSocket && chatState.chatSocket.readyState === WebSocket.OPEN) {
                    chatState.chatSocket.send(JSON.stringify({
                        'message': message
                    }));
                } else {
                    console.error('WebSocket still not connected, message not sent');
                    alert('Không thể kết nối. Vui lòng thử lại.');
                }
            }, 500);
        }
        
        input.value = '';
    }
    
    // Get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Update Unread Badge
    function updateUnreadBadge(totalUnread) {
        const badge = document.getElementById('unreadBadge');
        if (totalUnread > 0) {
            badge.textContent = totalUnread > 99 ? '99+' : totalUnread;
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
    }
    
    // Handle chat item click
    window.handleChatItemClick = function(roomDataId) {
        console.log('handleChatItemClick called with roomDataId:', roomDataId);
        const roomData = window[roomDataId];
        if (roomData && roomData.roomName && roomData.otherUser) {
            console.log('Opening chat detail:', roomData);
            showChatDetail(roomData.roomName, roomData.otherUser, roomData.isBot || false);
            // Clean up after a delay to ensure it's used
            setTimeout(() => {
                delete window[roomDataId];
            }, 1000);
        } else {
            console.error('Invalid room data:', roomData);
        }
    };
</script>
{% endif %}
{% endblock %}
