{% extends 'core/base.html' %}

{% block title %}Chat với {{ other_user.full_name }} - Organic Hub{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Chat Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <a href="{% url 'chat_list' %}" class="btn btn-outline-secondary rounded-pill me-3">
                        <i class="fas fa-arrow-left me-2"></i>Danh sách chat
                    </a>
                    <div class="d-flex align-items-center">
                        <!-- Other User Avatar -->
                        <div class="me-3">
                            {% if other_user.avatar %}
                                <img src="{{ other_user.avatar.url }}" 
                                     alt="{{ other_user.full_name }}" 
                                     class="rounded-circle" 
                                     style="width: 50px; height: 50px; object-fit: cover;">
                            {% else %}
                                <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 50px; height: 50px;">
                                    <i class="fas fa-user text-primary"></i>
                                </div>
                            {% endif %}
                        </div>
                        <div>
                            <h1 class="display-6 fw-bold mb-1">Chat với {{ other_user.full_name }}</h1>
                            <p class="text-muted mb-0">Trò chuyện trực tiếp</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Container -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm rounded-4" style="height: 70vh;">
                <!-- Chat Messages -->
                <div id="chat-messages" class="card-body p-4 overflow-auto" style="height: calc(100% - 80px);">
                    {% for message in chat_history %}
                        <div class="d-flex mb-3 {% if message.sender.user_id == request.user.user_id %}justify-content-end{% else %}justify-content-start{% endif %}">
                            <div class="{% if message.sender.user_id == request.user.user_id %}bg-primary text-white{% else %}bg-light{% endif %} rounded-4 p-3" 
                                 style="max-width: 70%;">
                                <div class="message-content">{{ message.content }}</div>
                                <div class="small mt-1 {% if message.sender.user_id == request.user.user_id %}text-white-50{% else %}text-muted{% endif %}">
                                    {{ message.sender.full_name }} - {{ message.created_at|date:"H:i" }}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <!-- Chat Input -->
                <div class="card-footer bg-white border-0 p-4">
                    <div class="input-group">
                        <input id="chat-message-input" 
                               type="text" 
                               class="form-control form-control-lg rounded-pill" 
                               placeholder="Nhập tin nhắn..." 
                               autocomplete="off">
                        <button id="chat-message-submit" 
                                class="btn btn-primary rounded-pill px-4" 
                                type="button">
                            <i class="fas fa-paper-plane me-1"></i>Gửi
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
    <!-- Dùng để lấy tên phòng từ Django sang JS -->
    {{ room_name|json_script:"room-name" }}
    {{ request.user.user_id|json_script:"current-user-id" }}

    <script>
        const roomName = JSON.parse(document.getElementById('room-name').textContent);
        const currentUserId = JSON.parse(document.getElementById('current-user-id').textContent);
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('chat-message-input');
        const submitButton = document.getElementById('chat-message-submit');

        // 1. Tạo kết nối WebSocket
        const chatSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/chat/private/' + roomName + '/'
        );
        
        // Kiểm tra và gửi tin nhắn về sản phẩm nếu có
        chatSocket.onopen = function(e) {
            console.log('WebSocket connected');
            
            // Kiểm tra xem có thông tin sản phẩm từ localStorage không
            const productName = localStorage.getItem('productName');
            const storeOwnerId = localStorage.getItem('storeOwnerId');
            
            console.log('Product name:', productName);
            console.log('Store owner ID:', storeOwnerId);
            console.log('Chat messages count:', chatMessages.children.length);
            
            if (productName && storeOwnerId) {
                // Tạo tin nhắn mặc định về sản phẩm
                const defaultMessage = `Tôi đang quan tâm tới sản phẩm '${productName}' này, bạn có thể cho tôi biết thêm về nó?`;
                
                console.log('Sending default message:', defaultMessage);
                
                // Gửi tin nhắn sau 1 giây để đảm bảo kết nối ổn định
                setTimeout(() => {
                    sendMessage(defaultMessage);
                    // Xóa thông tin sản phẩm khỏi localStorage sau khi gửi
                    localStorage.removeItem('productName');
                    localStorage.removeItem('storeOwnerId');
                }, 1000);
            }
        };

        // 2. Xử lý tin nhắn nhận được
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const message = data.message;
            const username = data.username;
            const senderId = data.sender_id;
            
            // Chỉ hiển thị tin nhắn từ người khác
            if (senderId != currentUserId) {
                addMessage(message, username, false); // false = received message
            }
        };

        // 3. Gửi tin nhắn từ input
        function sendMessageFromInput() {
            const message = messageInput.value.trim();
            if (message) {
                sendMessage(message);
                messageInput.value = '';
            }
        }
        
        // 4. Gửi tin nhắn (có thể từ input hoặc programmatically)
        function sendMessage(message) {
            if (message) {
                // Hiển thị tin nhắn của mình ngay lập tức
                addMessage(message, "Bạn", true); // true = sent message
                
                // Gửi qua WebSocket
                chatSocket.send(JSON.stringify({
                    'message': message
                }));
            }
        }

        // 4. Thêm tin nhắn vào giao diện
        function addMessage(content, sender, isSent) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `d-flex mb-3 ${isSent ? 'justify-content-end' : 'justify-content-start'}`;
            
            const messageBubble = document.createElement('div');
            messageBubble.className = `${isSent ? 'bg-primary text-white' : 'bg-light'} rounded-4 p-3`;
            messageBubble.style.maxWidth = '70%';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = content;
            
            const messageInfo = document.createElement('div');
            messageInfo.className = `small mt-1 ${isSent ? 'text-white-50' : 'text-muted'}`;
            messageInfo.textContent = `${sender} - ${new Date().toLocaleTimeString()}`;
            
            messageBubble.appendChild(messageContent);
            messageBubble.appendChild(messageInfo);
            messageDiv.appendChild(messageBubble);
            chatMessages.appendChild(messageDiv);
            
            // Scroll xuống cuối
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 5. Event listeners
        submitButton.onclick = sendMessageFromInput;
        
        messageInput.onkeyup = function(e) {
            if (e.key === 'Enter') {
                sendMessageFromInput();
            }
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        // Focus vào input
        messageInput.focus();
        
        // Scroll xuống cuối khi load trang
        chatMessages.scrollTop = chatMessages.scrollHeight;
    </script>
{% endblock %}